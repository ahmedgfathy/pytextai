<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Real Estate Data Viewer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com/3.3.0"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'whatsapp': '#25D366',
                        'whatsapp-dark': '#075E54',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        
        .rtl-text {
            direction: rtl;
            text-align: right;
        }
        
        .ltr-text {
            direction: ltr;
            text-align: left;
        }
        
        .search-highlight {
            background-color: #fef08a;
            font-weight: 600;
        }
        
        .table-row:hover {
            background-color: #f0fdf4;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            margin: 0.125rem;
            display: inline-block;
        }
        
        .property-land { background-color: #dcfce7; color: #16a34a; }
        .property-apartment { background-color: #dbeafe; color: #2563eb; }
        .property-villa { background-color: #fef3c7; color: #d97706; }
        .property-commercial { background-color: #f3e8ff; color: #9333ea; }
        
        .category-residential { background-color: #ecfdf5; color: #059669; }
        .category-commercial { background-color: #fef3c7; color: #d97706; }
        .category-factory { background-color: #e7e5e4; color: #57534e; }
        .category-shop { background-color: #fce7f3; color: #be185d; }
        
        .phone-number {
            font-family: 'Courier New', monospace;
            background-color: #f1f5f9;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
            max-height: 2.6em;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
            max-height: 4.2em;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .action-button {
            padding: 0.25rem 0.5rem;
            margin: 0.125rem;
            border-radius: 0.25rem;
            font-size: 0.65rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .btn-view {
            background-color: #3b82f6;
            color: white;
        }
        .btn-view:hover {
            background-color: #2563eb;
        }
        
        .btn-edit {
            background-color: #f59e0b;
            color: white;
        }
        .btn-edit:hover {
            background-color: #d97706;
        }
        
        .btn-delete {
            background-color: #ef4444;
            color: white;
        }
        .btn-delete:hover {
            background-color: #dc2626;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            direction: rtl;
        }
        
        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-whatsapp-dark text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="text-left">
                    <div class="text-lg font-semibold" id="total-records"></div>
                    <div class="text-sm text-green-200">إجمالي السجلات</div>
                </div>
                <div class="flex items-center space-x-reverse space-x-4">
                    <div class="bg-whatsapp p-3 rounded-lg">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.89 3.486"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">عارض بيانات العقارات من الواتساب</h1>
                        <p class="text-green-200">بيانات مستخرجة ومنظمة من محادثات الواتساب</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Statistics Bar -->
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="with-phone"></div>
                    <div class="text-sm text-gray-600">لديهم أرقام هواتف</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="apartments"></div>
                    <div class="text-sm text-gray-600">شقق</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600" id="villas"></div>
                    <div class="text-sm text-gray-600">فيلات</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-emerald-600" id="lands"></div>
                    <div class="text-sm text-gray-600">قطع أراضي</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">المرشحات والبحث</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">البحث في الرسائل</label>
                    <input type="text" id="search-input" placeholder="ابحث في الرسائل..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-whatsapp">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">نوع العقار</label>
                    <select id="property-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-whatsapp">
                        <option value="">جميع الأنواع</option>
                        <option value="شقة">شقة</option>
                        <option value="فيلا">فيلا</option>
                        <option value="قطعة أرض">قطعة أرض</option>
                        <option value="تجاري">تجاري</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">الحالة</label>
                    <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-whatsapp">
                        <option value="">جميع الحالات</option>
                        <option value="للبيع">للبيع</option>
                        <option value="مطلوب">مطلوب</option>
                        <option value="ايجار">إيجار</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">التاريخ</label>
                    <input type="date" id="date-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-whatsapp">
                </div>
                <div class="flex items-end">
                    <button onclick="clearFilters()" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
                        مسح المرشحات
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="w-full">
                <table class="w-full divide-y divide-gray-200 table-fixed">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="w-24 px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                            <th class="w-20 px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">فئة العقار</th>
                            <th class="w-20 px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">نوع العقار</th>
                            <th class="w-32 px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المنطقة</th>
                            <th class="w-24 px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الرسالة</th>
                            <th class="w-32 px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">أرقام الهواتف</th>
                            <th class="w-32 px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المرسل</th>
                            <th class="w-24 px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ/الوقت</th>
                            <th class="w-20 px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المعرف</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                <div class="flex-1 flex justify-between sm:hidden">
                    <button onclick="nextPage()" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">التالي</button>
                    <button onclick="previousPage()" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">السابق</button>
                </div>
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            عرض <span id="showing-from" class="font-medium"></span> إلى <span id="showing-to" class="font-medium"></span> من <span id="total-showing" class="font-medium"></span> نتيجة
                        </p>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <button onclick="nextPage()" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">التالي</button>
                            <span id="page-info" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700"></span>
                            <button onclick="previousPage()" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">السابق</button>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for viewing details -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">تفاصيل السجل</h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Modal for editing -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">تعديل السجل</h2>
            <form id="editForm">
                <div id="editFormContent"></div>
                <div class="mt-6 flex justify-end space-x-reverse space-x-3">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">إلغاء</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentData = [];
        let filteredData = [];
        let currentPage = 1;
        const recordsPerPage = 50; // Increased from 20 to 50 for better viewing
        let isLoading = false;

        // Load CSV file dynamically
        async function loadCSVData() {
            try {
                isLoading = true;
                showLoadingMessage();
                
                const response = await fetch('whatsapp_chats.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                console.error('Error loading CSV file:', error);
                showErrorMessage('Error loading data. Please make sure whatsapp_chats.csv is in the same directory.');
                return [];
            } finally {
                isLoading = false;
            }
        }

        function showLoadingMessage() {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center">
                        <div class="flex items-center justify-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-whatsapp mr-3"></div>
                            <span class="text-lg text-gray-600">Loading data... Please wait</span>
                        </div>
                    </td>
                </tr>
            `;
        }

        function showErrorMessage(message) {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center">
                        <div class="text-red-600">
                            <div class="text-lg font-semibold">${message}</div>
                            <div class="mt-2 text-sm">Make sure the HTML file and CSV file are in the same directory.</div>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Parse CSV data
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',');
            
            return lines.slice(1).map(line => {
                const values = parseCSVLine(line);
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                return obj;
            });
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Initialize data
        async function initializeData() {
            currentData = await loadCSVData();
            if (currentData.length > 0) {
                // Add property category to each record
                currentData = currentData.map(item => ({
                    ...item,
                    property_category: determinePropertyCategory(item.message, item.property_type)
                }));
                
                filteredData = [...currentData];
                updateStatistics();
                displayData();
            }
        }

        // Function to determine property category from message content
        function determinePropertyCategory(message, propertyType) {
            if (!message) return 'غير محدد';
            
            const text = message.toLowerCase();
            
            // Commercial keywords
            const commercialKeywords = [
                'محل', 'مطعم', 'كافيه', 'صيدلية', 'عيادة', 'مكتب', 'بنك', 'شركة',
                'استوديو', 'معرض', 'صالون', 'مركز', 'سوق', 'مول', 'تجاري', 'عمارة تجارية',
                'shop', 'restaurant', 'cafe', 'pharmacy', 'clinic', 'office', 'bank',
                'studio', 'showroom', 'salon', 'center', 'mall', 'commercial'
            ];
            
            // Factory keywords
            const factoryKeywords = [
                'مصنع', 'ورشة', 'مستودع', 'صناعي', 'انتاج', 'تصنيع', 'مخزن',
                'منطقة صناعية', 'قطاع صناعي', 'خط انتاج', 'معمل',
                'factory', 'warehouse', 'industrial', 'production', 'manufacturing',
                'storage', 'plant', 'mill', 'workshop'
            ];
            
            // Shop specific keywords
            const shopKeywords = [
                'محل ملابس', 'محل احذية', 'محل عطور', 'محل ذهب', 'محل موبايل',
                'محل كمبيوتر', 'محل اكسسوارات', 'بوتيك', 'متجر',
                'clothing store', 'shoe store', 'perfume shop', 'jewelry store',
                'mobile shop', 'computer store', 'boutique', 'store'
            ];
            
            // Residential keywords
            const residentialKeywords = [
                'شقة', 'فيلا', 'بيت', 'منزل', 'دوبليكس', 'روف', 'استوديو سكني',
                'عمارة سكنية', 'كمبوند', 'وحدة سكنية', 'قطعة ارض سكنية',
                'apartment', 'villa', 'house', 'home', 'duplex', 'roof',
                'residential', 'compound', 'unit'
            ];
            
            // Check for factory first (most specific)
            if (factoryKeywords.some(keyword => text.includes(keyword))) {
                return 'صناعي';
            }
            
            // Check for shop (specific type of commercial)
            if (shopKeywords.some(keyword => text.includes(keyword))) {
                return 'محل تجاري';
            }
            
            // Check for commercial
            if (commercialKeywords.some(keyword => text.includes(keyword))) {
                return 'تجاري';
            }
            
            // Check for residential
            if (residentialKeywords.some(keyword => text.includes(keyword))) {
                return 'سكني';
            }
            
            // Fallback based on property type
            if (propertyType) {
                if (['apartment', 'villa', 'شقة', 'فيلا'].includes(propertyType)) {
                    return 'سكني';
                }
                if (['commercial', 'تجاري'].includes(propertyType)) {
                    return 'تجاري';
                }
            }
            
            return 'غير محدد';
        }

        // Update statistics
        function updateStatistics() {
            const total = filteredData.length;
            const withPhone = filteredData.filter(item => item.sender_phone || item.sender_phone_2).length;
            const apartments = filteredData.filter(item => item.property_type === 'شقة' || item.property_type === 'apartment').length;
            const villas = filteredData.filter(item => item.property_type === 'فيلا' || item.property_type === 'villa').length;
            const lands = filteredData.filter(item => item.property_type === 'قطعة أرض' || item.property_type === 'land').length;

            document.getElementById('total-records').textContent = total.toLocaleString();
            document.getElementById('with-phone').textContent = withPhone.toLocaleString();
            document.getElementById('apartments').textContent = apartments.toLocaleString();
            document.getElementById('villas').textContent = villas.toLocaleString();
            document.getElementById('lands').textContent = lands.toLocaleString();
        }

        // Display data in table
        function displayData() {
            const tbody = document.getElementById('data-table-body');
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);

            if (pageData.length === 0 && filteredData.length === 0 && !isLoading) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-6 py-12 text-center">
                            <div class="text-gray-500">
                                <div class="text-lg">لا توجد بيانات</div>
                                <div class="text-sm mt-2">جرب تعديل مرشحات البحث</div>
                            </div>
                        </td>
                    </tr>
                `;
                updatePaginationInfo();
                return;
            }

            tbody.innerHTML = pageData.map((item, index) => `
                <tr class="table-row">
                    <td class="px-3 py-2 text-sm text-gray-500">
                        <div class="flex space-x-reverse space-x-1">
                            <button onclick="viewDetails(${startIndex + index})" class="action-button btn-view" title="عرض التفاصيل">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                            <button onclick="editRecord(${startIndex + index})" class="action-button btn-edit" title="تعديل">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                </svg>
                            </button>
                            <button onclick="deleteRecord(${startIndex + index})" class="action-button btn-delete" title="حذف">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 112 0v3a1 1 0 11-2 0V9zm4 0a1 1 0 112 0v3a1 1 0 11-2 0V9z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                    <td class="px-3 py-2 text-sm text-gray-500">
                        ${formatPropertyCategory(item.property_category)}
                    </td>
                    <td class="px-3 py-2 text-sm text-gray-500">
                        ${formatPropertyType(item.property_type)}
                    </td>
                    <td class="px-3 py-2 text-sm text-gray-500 rtl-text">
                        <div class="truncate text-xs" title="${item.region}">${highlightSearchTerm(item.region)}</div>
                    </td>
                    <td class="px-3 py-2 text-sm text-gray-500">
                        ${formatStatus(item.status)}
                    </td>
                    <td class="px-3 py-2 text-sm text-gray-900 rtl-text">
                        <div class="line-clamp-2 text-xs leading-tight" title="${item.message}">${highlightSearchTerm(item.message)}</div>
                    </td>
                    <td class="px-3 py-2 text-sm text-gray-500">
                        ${item.sender_phone ? `<div class="phone-number mb-1 ltr-text text-xs">${item.sender_phone}</div>` : ''}
                        ${item.sender_phone_2 ? `<div class="phone-number ltr-text text-xs">${item.sender_phone_2}</div>` : ''}
                    </td>
                    <td class="px-3 py-2 text-sm text-gray-900 rtl-text">
                        <div class="truncate text-xs" title="${item.sender_name}">${item.sender_name}</div>
                    </td>
                    <td class="px-3 py-2 text-sm text-gray-500">
                        <div class="ltr-text text-xs">${item.date}</div>
                        <div class="text-xs text-gray-400 ltr-text">${item.time}</div>
                    </td>
                    <td class="px-3 py-2 text-sm font-medium text-gray-900 ltr-text text-xs">${item.unique_id}</td>
                </tr>
            `).join('');

            updatePaginationInfo();
        }

        function highlightSearchTerm(text) {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (!searchTerm || !text) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function formatStatus(status) {
            if (!status) return '';
            return status.split(',').map(s => 
                `<span class="status-badge bg-green-100 text-green-800">${s.trim()}</span>`
            ).join('');
        }

        function formatPropertyType(type) {
            if (!type) return '';
            
            // Map English property types to Arabic (for backward compatibility)
            const propertyTypeMap = {
                'land': 'قطعة أرض',
                'apartment': 'شقة',
                'villa': 'فيلا',
                'commercial': 'تجاري'
            };
            
            // Check if it's already Arabic
            const arabicTypes = ['قطعة أرض', 'شقة', 'فيلا', 'تجاري'];
            let arabicType, englishType;
            
            if (arabicTypes.includes(type)) {
                arabicType = type;
                // Get English equivalent for CSS class
                const reverseMap = {
                    'قطعة أرض': 'land',
                    'شقة': 'apartment', 
                    'فيلا': 'villa',
                    'تجاري': 'commercial'
                };
                englishType = reverseMap[type] || type;
            } else {
                arabicType = propertyTypeMap[type] || type;
                englishType = type;
            }
            
            const className = `property-${englishType}`;
            return `<span class="status-badge ${className}">${arabicType}</span>`;
        }

        function formatPropertyCategory(category) {
            if (!category) return '';
            
            const categoryMap = {
                'سكني': 'residential',
                'تجاري': 'commercial', 
                'صناعي': 'factory',
                'محل تجاري': 'shop'
            };
            
            const englishCategory = categoryMap[category] || 'residential';
            const className = `category-${englishCategory}`;
            return `<span class="status-badge ${className}">${category}</span>`;
        }

        function updatePaginationInfo() {
            const startIndex = (currentPage - 1) * recordsPerPage + 1;
            const endIndex = Math.min(currentPage * recordsPerPage, filteredData.length);
            const total = filteredData.length;

            document.getElementById('showing-from').textContent = startIndex;
            document.getElementById('showing-to').textContent = endIndex;
            document.getElementById('total-showing').textContent = total;
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${Math.ceil(total / recordsPerPage)}`;
        }

        // Filtering functions
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const propertyType = document.getElementById('property-filter').value;
            const status = document.getElementById('status-filter').value;
            const date = document.getElementById('date-filter').value;

            filteredData = currentData.filter(item => {
                // Enhanced search - search across ALL columns
                const matchesSearch = !searchTerm || 
                    Object.values(item).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );

                const matchesPropertyType = !propertyType || item.property_type === propertyType;
                const matchesStatus = !status || (item.status && item.status.includes(status));
                
                // Improved date matching
                let matchesDate = true;
                if (date) {
                    const filterDate = date.split('-').reverse().join('/'); // Convert YYYY-MM-DD to DD/MM/YYYY
                    matchesDate = item.date.includes(filterDate);
                }

                return matchesSearch && matchesPropertyType && matchesStatus && matchesDate;
            });

            currentPage = 1;
            updateStatistics();
            displayData();
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('property-filter').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('date-filter').value = '';
            applyFilters();
        }

        // Debounced search for better performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedSearch = debounce(applyFilters, 300);

        // Action functions
        function viewDetails(index) {
            const item = filteredData[index];
            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">المعرف:</label>
                            <p class="mt-1 text-sm text-gray-900 ltr-text">${item.unique_id}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">الملف المصدر:</label>
                            <p class="mt-1 text-sm text-gray-900 ltr-text">${item.file_source}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">التاريخ:</label>
                            <p class="mt-1 text-sm text-gray-900 ltr-text">${item.date}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">الوقت:</label>
                            <p class="mt-1 text-sm text-gray-900 ltr-text">${item.time}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">اسم المرسل:</label>
                            <p class="mt-1 text-sm text-gray-900">${item.sender_name}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">الهاتف الأساسي:</label>
                            <p class="mt-1 text-sm text-gray-900 ltr-text">${item.sender_phone || 'غير متوفر'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">الهاتف الثانوي:</label>
                            <p class="mt-1 text-sm text-gray-900 ltr-text">${item.sender_phone_2 || 'غير متوفر'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">نوع العقار:</label>
                            <p class="mt-1 text-sm text-gray-900">${item.property_type || 'غير محدد'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">فئة العقار:</label>
                            <p class="mt-1 text-sm text-gray-900">${item.property_category || 'غير محدد'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">الحالة:</label>
                            <p class="mt-1 text-sm text-gray-900">${item.status || 'غير محدد'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">المنطقة:</label>
                            <p class="mt-1 text-sm text-gray-900">${item.region || 'غير محدد'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">رقم السطر:</label>
                            <p class="mt-1 text-sm text-gray-900 ltr-text">${item.line_number}</p>
                        </div>
                    </div>
                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700">الرسالة:</label>
                        <p class="mt-1 text-sm text-gray-900 p-3 bg-gray-50 rounded-md">${item.message}</p>
                    </div>
                    <div class="col-span-full">
                        <label class="block text-sm font-medium text-gray-700">نسخة احتياطية من الرسالة:</label>
                        <p class="mt-1 text-sm text-gray-900 p-3 bg-gray-50 rounded-md">${item.message_backup}</p>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function editRecord(index) {
            const item = filteredData[index];
            const modal = document.getElementById('editModal');
            const content = document.getElementById('editFormContent');
            
            content.innerHTML = `
                <input type="hidden" id="editIndex" value="${index}">
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">اسم المرسل:</label>
                            <input type="text" id="edit_sender_name" value="${item.sender_name}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">الهاتف الأساسي:</label>
                            <input type="text" id="edit_sender_phone" value="${item.sender_phone}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md ltr-text">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">الهاتف الثانوي:</label>
                            <input type="text" id="edit_sender_phone_2" value="${item.sender_phone_2}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md ltr-text">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">نوع العقار:</label>
                            <select id="edit_property_type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="">غير محدد</option>
                                <option value="apartment" ${item.property_type === 'apartment' ? 'selected' : ''}>شقة</option>
                                <option value="villa" ${item.property_type === 'villa' ? 'selected' : ''}>فيلا</option>
                                <option value="land" ${item.property_type === 'land' ? 'selected' : ''}>أرض</option>
                                <option value="commercial" ${item.property_type === 'commercial' ? 'selected' : ''}>تجاري</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">فئة العقار:</label>
                            <select id="edit_property_category" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="">غير محدد</option>
                                <option value="سكني" ${item.property_category === 'سكني' ? 'selected' : ''}>سكني</option>
                                <option value="تجاري" ${item.property_category === 'تجاري' ? 'selected' : ''}>تجاري</option>
                                <option value="صناعي" ${item.property_category === 'صناعي' ? 'selected' : ''}>صناعي</option>
                                <option value="محل تجاري" ${item.property_category === 'محل تجاري' ? 'selected' : ''}>محل تجاري</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">الحالة:</label>
                            <input type="text" id="edit_status" value="${item.status}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">المنطقة:</label>
                            <input type="text" id="edit_region" value="${item.region}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">الرسالة:</label>
                        <textarea id="edit_message" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">${item.message}</textarea>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function deleteRecord(index) {
            const item = filteredData[index];
            if (confirm(`هل أنت متأكد من حذف السجل ${item.unique_id}؟`)) {
                // Find the index in the original data
                const originalIndex = currentData.findIndex(record => record.unique_id === item.unique_id);
                if (originalIndex !== -1) {
                    currentData.splice(originalIndex, 1);
                    applyFilters(); // Refresh the filtered data
                    alert('تم حذف السجل بنجاح');
                }
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Handle edit form submission
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const index = parseInt(document.getElementById('editIndex').value);
            const item = filteredData[index];
            
            // Update the item
            const updatedItem = {
                ...item,
                sender_name: document.getElementById('edit_sender_name').value,
                sender_phone: document.getElementById('edit_sender_phone').value,
                sender_phone_2: document.getElementById('edit_sender_phone_2').value,
                property_type: document.getElementById('edit_property_type').value,
                property_category: document.getElementById('edit_property_category').value,
                status: document.getElementById('edit_status').value,
                region: document.getElementById('edit_region').value,
                message: document.getElementById('edit_message').value
            };
            
            // Find and update in original data
            const originalIndex = currentData.findIndex(record => record.unique_id === item.unique_id);
            if (originalIndex !== -1) {
                currentData[originalIndex] = updatedItem;
                applyFilters(); // Refresh the display
                closeEditModal();
                alert('تم تحديث السجل بنجاح');
            }
        });

        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / recordsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayData();
                window.scrollTo(0, 0); // Scroll to top when changing pages
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayData();
                window.scrollTo(0, 0); // Scroll to top when changing pages
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            
            document.getElementById('search-input').addEventListener('input', debouncedSearch);
            document.getElementById('property-filter').addEventListener('change', applyFilters);
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('date-filter').addEventListener('change', applyFilters);
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('search-input').focus();
                }
                if (e.key === 'Escape') {
                    closeModal();
                    closeEditModal();
                }
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                const detailsModal = document.getElementById('detailsModal');
                const editModal = document.getElementById('editModal');
                
                if (e.target === detailsModal) {
                    closeModal();
                }
                if (e.target === editModal) {
                    closeEditModal();
                }
            });
        });
    </script>
</body>
</html>
