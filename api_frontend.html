<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate API Frontend - عارض بيانات العقارات</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'whatsapp': '#25D366',
                        'whatsapp-dark': '#075E54',
                        'api': '#3b82f6'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        
        .rtl-text {
            direction: rtl;
            text-align: right;
        }
        
        .ltr-text {
            direction: ltr;
            text-align: left;
        }
        
        .search-highlight {
            background-color: #fef08a;
            font-weight: 600;
        }
        
        .table-row:hover {
            background-color: #f0fdf4;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            margin: 0.125rem;
            display: inline-block;
        }
        
        .property-land { background-color: #dcfce7; color: #16a34a; }
        .property-apartment { background-color: #dbeafe; color: #2563eb; }
        .property-villa { background-color: #fef3c7; color: #d97706; }
        .property-commercial { background-color: #f3e8ff; color: #9333ea; }
        
        .phone-number {
            font-family: 'Courier New', monospace;
            background-color: #f1f5f9;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        
        .api-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            z-index: 1000;
        }
        
        .api-connected { background-color: #10b981; }
        .api-disconnected { background-color: #ef4444; }
        .api-loading { background-color: #f59e0b; }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            direction: rtl;
        }
        
        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- API Status Indicator -->
    <div id="api-status" class="api-status api-loading">
        <div class="flex items-center">
            <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-white mr-2"></div>
            <span>جاري الاتصال بـ API...</span>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-api text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="text-left">
                    <div class="text-lg font-semibold" id="total-records">0</div>
                    <div class="text-sm text-blue-200">إجمالي السجلات</div>
                    <div class="text-xs text-blue-300 mt-1">
                        <span id="api-url">API: http://localhost:5000</span>
                    </div>
                </div>
                <div class="flex items-center space-x-reverse space-x-4">
                    <div class="bg-white/20 p-3 rounded-lg">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">عارض بيانات العقارات - API Frontend</h1>
                        <p class="text-blue-200">واجهة متصلة بقاعدة البيانات SQLite عبر Flask API</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Statistics Bar -->
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="text-center">
                    <div class="text-xl font-bold text-green-600" id="stats-senders">0</div>
                    <div class="text-sm text-gray-600">مرسلين فريدين</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold text-blue-600" id="stats-regions">0</div>
                    <div class="text-sm text-gray-600">مناطق</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold text-purple-600" id="stats-types">0</div>
                    <div class="text-sm text-gray-600">أنواع عقارات</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold text-yellow-600" id="stats-with-phone">0</div>
                    <div class="text-sm text-gray-600">بأرقام هواتف</div>
                </div>
                <div class="text-center">
                    <div class="text-xl font-bold text-red-600" id="stats-with-region">0</div>
                    <div class="text-sm text-gray-600">بمعلومات المنطقة</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">البحث والمرشحات</h3>
                <div class="flex space-x-reverse space-x-2">
                    <button onclick="loadStats()" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600">
                        تحديث الإحصائيات
                    </button>
                    <button onclick="clearAllFilters()" class="px-3 py-1 bg-gray-500 text-white rounded-md text-sm hover:bg-gray-600">
                        مسح الكل
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">البحث</label>
                    <input type="text" id="search-query" placeholder="ابحث في جميع الحقول..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-api">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">نوع العقار</label>
                    <select id="property-type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-api">
                        <option value="">جميع الأنواع</option>
                        <option value="land">أرض</option>
                        <option value="apartment">شقة</option>
                        <option value="villa">فيلا</option>
                        <option value="commercial">تجاري</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">المنطقة</label>
                    <input type="text" id="region-filter" placeholder="اسم المنطقة..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-api">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">المرسل</label>
                    <input type="text" id="sender-filter" placeholder="اسم المرسل..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-api">
                </div>
            </div>
            
            <div class="mt-4 flex items-center justify-between">
                <div class="flex items-center space-x-reverse space-x-4">
                    <button onclick="searchProperties()" class="px-4 py-2 bg-api text-white rounded-md hover:bg-blue-700">
                        بحث
                    </button>
                    <button onclick="loadAllProperties()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
                        عرض الكل
                    </button>
                </div>
                <div class="flex items-center space-x-reverse space-x-2 text-sm text-gray-600">
                    <label>عدد النتائج:</label>
                    <select id="limit-select" class="px-2 py-1 border border-gray-300 rounded">
                        <option value="20">20</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h3 class="text-md font-semibold mb-3">إجراءات سريعة</h3>
            <div class="flex flex-wrap gap-2">
                <button onclick="loadTopRegions()" class="px-3 py-1 bg-yellow-500 text-white rounded text-sm hover:bg-yellow-600">
                    أهم المناطق
                </button>
                <button onclick="loadTopSenders()" class="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600">
                    أكثر المرسلين نشاطاً
                </button>
                <button onclick="loadPropertyTypes()" class="px-3 py-1 bg-indigo-500 text-white rounded text-sm hover:bg-indigo-600">
                    توزيع أنواع العقارات
                </button>
                <button onclick="searchByKeyword('للبيع')" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                    عقارات للبيع
                </button>
                <button onclick="searchByKeyword('شقة')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                    الشقق
                </button>
                <button onclick="searchByKeyword('فيلا')" class="px-3 py-1 bg-orange-500 text-white rounded text-sm hover:bg-orange-600">
                    الفيلات
                </button>
            </div>
        </div>

        <!-- Results Container -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 bg-gray-50 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold">النتائج</h3>
                    <div id="results-info" class="text-sm text-gray-600">
                        جاري التحميل...
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="overflow-x-auto">
                <table class="w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المعرف</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المرسل</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الهاتف</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المنطقة</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">نوع العقار</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الرسالة</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200">
                <div class="flex items-center">
                    <span class="text-sm text-gray-700" id="pagination-info">
                        عرض النتائج
                    </span>
                </div>
                <div class="flex items-center space-x-reverse space-x-2">
                    <button onclick="previousPage()" id="prev-btn" 
                            class="px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm hover:bg-gray-400 disabled:opacity-50">
                        السابق
                    </button>
                    <button onclick="nextPage()" id="next-btn" 
                            class="px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm hover:bg-gray-400 disabled:opacity-50">
                        التالي
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Property Details Modal -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePropertyModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">تفاصيل العقار</h2>
            <div id="propertyDetails"></div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:5000';
        
        // State management
        let currentOffset = 0;
        let currentLimit = 50;
        let currentData = [];
        let hasMore = false;
        
        // Check API connection on load
        async function checkApiConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/`);
                if (response.ok) {
                    updateApiStatus('connected', 'متصل بـ API');
                    loadStats();
                    loadAllProperties();
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                updateApiStatus('disconnected', 'فشل الاتصال بـ API - تأكد من تشغيل الخادم');
                console.error('API connection failed:', error);
            }
        }
        
        function updateApiStatus(status, message) {
            const statusEl = document.getElementById('api-status');
            statusEl.className = `api-status api-${status}`;
            statusEl.innerHTML = `<span>${message}</span>`;
            
            if (status === 'connected') {
                setTimeout(() => statusEl.style.display = 'none', 3000);
            }
        }
        
        // Load database statistics
        async function loadStats() {
            try {
                updateApiStatus('loading', 'جاري تحميل الإحصائيات...');
                const response = await fetch(`${API_BASE_URL}/stats`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const stats = result.data;
                    document.getElementById('total-records').textContent = stats.total_properties.toLocaleString();
                    document.getElementById('stats-senders').textContent = stats.unique_senders.toLocaleString();
                    document.getElementById('stats-regions').textContent = stats.unique_regions.toLocaleString();
                    document.getElementById('stats-types').textContent = stats.unique_property_types.toLocaleString();
                    document.getElementById('stats-with-phone').textContent = stats.properties_with_phone.toLocaleString();
                    document.getElementById('stats-with-region').textContent = stats.properties_with_region.toLocaleString();
                    
                    updateApiStatus('connected', 'تم تحديث الإحصائيات');
                }
            } catch (error) {
                updateApiStatus('disconnected', 'خطأ في تحميل الإحصائيات');
                console.error('Error loading stats:', error);
            }
        }
        
        // Load all properties
        async function loadAllProperties() {
            const limit = document.getElementById('limit-select').value;
            const propertyType = document.getElementById('property-type-filter').value;
            const region = document.getElementById('region-filter').value;
            const sender = document.getElementById('sender-filter').value;
            
            let url = `${API_BASE_URL}/properties?limit=${limit}&offset=${currentOffset}`;
            
            if (propertyType) url += `&property_type=${encodeURIComponent(propertyType)}`;
            if (region) url += `&region=${encodeURIComponent(region)}`;
            if (sender) url += `&sender=${encodeURIComponent(sender)}`;
            
            try {
                updateApiStatus('loading', 'جاري تحميل البيانات...');
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.status === 'success') {
                    currentData = result.data;
                    hasMore = result.pagination.has_more;
                    displayProperties(result.data);
                    updatePaginationInfo(result.pagination);
                    updateApiStatus('connected', `تم تحميل ${result.data.length} عقار`);
                }
            } catch (error) {
                updateApiStatus('disconnected', 'خطأ في تحميل البيانات');
                console.error('Error loading properties:', error);
            }
        }
        
        // Search properties
        async function searchProperties() {
            const query = document.getElementById('search-query').value;
            if (!query.trim()) {
                loadAllProperties();
                return;
            }
            
            const limit = document.getElementById('limit-select').value;
            
            try {
                updateApiStatus('loading', 'جاري البحث...');
                const response = await fetch(`${API_BASE_URL}/search?q=${encodeURIComponent(query)}&limit=${limit}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    currentData = result.data;
                    displayProperties(result.data);
                    document.getElementById('pagination-info').textContent = `البحث عن "${query}" - ${result.count} نتيجة`;
                    updateApiStatus('connected', `تم العثور على ${result.count} نتيجة`);
                }
            } catch (error) {
                updateApiStatus('disconnected', 'خطأ في البحث');
                console.error('Error searching:', error);
            }
        }
        
        // Search by specific keyword
        async function searchByKeyword(keyword) {
            document.getElementById('search-query').value = keyword;
            await searchProperties();
        }
        
        // Display properties in table
        function displayProperties(properties) {
            const tbody = document.getElementById('data-table-body');
            
            if (properties.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                            <div class="text-lg">لا توجد نتائج</div>
                            <div class="text-sm mt-2">جرب تعديل مرشحات البحث</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = properties.map(property => `
                <tr class="table-row">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900 ltr-text">
                        ${property.unique_id || 'N/A'}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 rtl-text">
                        <div class="truncate max-w-32" title="${property.sender_name}">
                            ${property.sender_name || 'غير محدد'}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        ${property.sender_phone ? `<div class="phone-number ltr-text">${property.sender_phone}</div>` : 'غير متوفر'}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 rtl-text">
                        <div class="truncate max-w-32" title="${property.region}">
                            ${property.region || 'غير محدد'}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        ${formatPropertyType(property.property_type)}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 rtl-text">
                        <div class="truncate max-w-64" title="${property.message_preview}">
                            ${property.message_preview || 'لا توجد رسالة'}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 ltr-text">
                        <div class="text-xs">${property.date || ''}</div>
                        <div class="text-xs text-gray-400">${property.time || ''}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        <button onclick="viewPropertyDetails('${property.unique_id}')" 
                                class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                            تفاصيل
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Format property type
        function formatPropertyType(type) {
            if (!type) return '<span class="text-gray-400">غير محدد</span>';
            
            const typeMap = {
                'land': { ar: 'أرض', class: 'property-land' },
                'apartment': { ar: 'شقة', class: 'property-apartment' },
                'villa': { ar: 'فيلا', class: 'property-villa' },
                'commercial': { ar: 'تجاري', class: 'property-commercial' }
            };
            
            const typeInfo = typeMap[type] || { ar: type, class: 'status-badge' };
            return `<span class="status-badge ${typeInfo.class}">${typeInfo.ar}</span>`;
        }
        
        // View property details
        async function viewPropertyDetails(uniqueId) {
            try {
                const response = await fetch(`${API_BASE_URL}/property/${uniqueId}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const property = result.data;
                    showPropertyModal(property);
                } else {
                    alert('خطأ في تحميل تفاصيل العقار');
                }
            } catch (error) {
                alert('خطأ في الاتصال بالخادم');
                console.error('Error loading property details:', error);
            }
        }
        
        // Show property modal
        function showPropertyModal(property) {
            const modal = document.getElementById('propertyModal');
            const details = document.getElementById('propertyDetails');
            
            details.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">المعرف:</label>
                        <p class="mt-1 text-sm text-gray-900 ltr-text">${property.unique_id || 'غير محدد'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">المصدر:</label>
                        <p class="mt-1 text-sm text-gray-900 ltr-text">${property.file_source || 'غير محدد'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">التاريخ:</label>
                        <p class="mt-1 text-sm text-gray-900 ltr-text">${property.date || 'غير محدد'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">الوقت:</label>
                        <p class="mt-1 text-sm text-gray-900 ltr-text">${property.time || 'غير محدد'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">المرسل:</label>
                        <p class="mt-1 text-sm text-gray-900">${property.sender_name || 'غير محدد'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">الهاتف الأساسي:</label>
                        <p class="mt-1 text-sm text-gray-900 ltr-text">${property.sender_phone || 'غير متوفر'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">الهاتف الثانوي:</label>
                        <p class="mt-1 text-sm text-gray-900 ltr-text">${property.sender_phone_2 || 'غير متوفر'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">نوع العقار:</label>
                        <p class="mt-1 text-sm text-gray-900">${property.property_type || 'غير محدد'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">المنطقة:</label>
                        <p class="mt-1 text-sm text-gray-900">${property.region || 'غير محدد'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">الحالة:</label>
                        <p class="mt-1 text-sm text-gray-900">${property.status || 'غير محدد'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">رقم السطر:</label>
                        <p class="mt-1 text-sm text-gray-900 ltr-text">${property.line_number || 'غير محدد'}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">الرسالة الكاملة:</label>
                    <div class="mt-1 p-3 bg-gray-50 rounded-md text-sm text-gray-900 rtl-text max-h-32 overflow-y-auto">
                        ${property.message || 'لا توجد رسالة'}
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">النسخة الاحتياطية:</label>
                    <div class="mt-1 p-3 bg-gray-50 rounded-md text-sm text-gray-900 rtl-text max-h-32 overflow-y-auto">
                        ${property.message_backup || 'لا توجد نسخة احتياطية'}
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function closePropertyModal() {
            document.getElementById('propertyModal').style.display = 'none';
        }
        
        // Load top regions
        async function loadTopRegions() {
            try {
                const response = await fetch(`${API_BASE_URL}/regions?limit=20`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    showDataModal('أهم 20 منطقة', result.data.map(item => 
                        `<tr><td class="px-4 py-2 border-b">${item.region}</td><td class="px-4 py-2 border-b ltr-text">${item.property_count.toLocaleString()}</td></tr>`
                    ).join(''), ['المنطقة', 'عدد العقارات']);
                }
            } catch (error) {
                alert('خطأ في تحميل البيانات');
            }
        }
        
        // Load top senders
        async function loadTopSenders() {
            try {
                const response = await fetch(`${API_BASE_URL}/senders?limit=15`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    showDataModal('أكثر 15 مرسل نشاطاً', result.data.map(item => 
                        `<tr><td class="px-4 py-2 border-b">${item.sender_name}</td><td class="px-4 py-2 border-b ltr-text">${item.message_count.toLocaleString()}</td><td class="px-4 py-2 border-b ltr-text">${item.regions_covered}</td></tr>`
                    ).join(''), ['المرسل', 'عدد الرسائل', 'المناطق المغطاة']);
                }
            } catch (error) {
                alert('خطأ في تحميل البيانات');
            }
        }
        
        // Load property types
        async function loadPropertyTypes() {
            try {
                const response = await fetch(`${API_BASE_URL}/property-types`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    showDataModal('توزيع أنواع العقارات', result.data.map(item => 
                        `<tr><td class="px-4 py-2 border-b">${formatPropertyType(item.property_type)}</td><td class="px-4 py-2 border-b ltr-text">${item.count.toLocaleString()}</td><td class="px-4 py-2 border-b ltr-text">${item.percentage}%</td></tr>`
                    ).join(''), ['نوع العقار', 'العدد', 'النسبة']);
                }
            } catch (error) {
                alert('خطأ في تحميل البيانات');
            }
        }
        
        // Show data modal
        function showDataModal(title, rows, headers) {
            const modal = document.getElementById('propertyModal');
            const details = document.getElementById('propertyDetails');
            
            details.innerHTML = `
                <h3 class="text-lg font-semibold mb-4">${title}</h3>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                ${headers.map(header => `<th class="px-4 py-2 border-b text-right font-medium">${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        // Update pagination info
        function updatePaginationInfo(pagination) {
            const info = document.getElementById('pagination-info');
            info.textContent = `عرض ${pagination.offset + 1} - ${pagination.offset + currentData.length} من ${pagination.total.toLocaleString()} عقار`;
            
            document.getElementById('prev-btn').disabled = pagination.offset === 0;
            document.getElementById('next-btn').disabled = !pagination.has_more;
        }
        
        // Pagination functions
        function nextPage() {
            if (hasMore) {
                currentOffset += currentLimit;
                loadAllProperties();
            }
        }
        
        function previousPage() {
            if (currentOffset > 0) {
                currentOffset = Math.max(0, currentOffset - currentLimit);
                loadAllProperties();
            }
        }
        
        // Clear all filters
        function clearAllFilters() {
            document.getElementById('search-query').value = '';
            document.getElementById('property-type-filter').value = '';
            document.getElementById('region-filter').value = '';
            document.getElementById('sender-filter').value = '';
            currentOffset = 0;
            loadAllProperties();
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            checkApiConnection();
            
            // Enter key for search
            document.getElementById('search-query').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchProperties();
                }
            });
            
            // Limit change
            document.getElementById('limit-select').addEventListener('change', function() {
                currentLimit = parseInt(this.value);
                currentOffset = 0;
                loadAllProperties();
            });
            
            // Filter changes
            document.getElementById('property-type-filter').addEventListener('change', function() {
                currentOffset = 0;
                loadAllProperties();
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                const modal = document.getElementById('propertyModal');
                if (e.target === modal) {
                    closePropertyModal();
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('search-query').focus();
                }
                if (e.key === 'Escape') {
                    closePropertyModal();
                }
            });
        });
    </script>
</body>
</html>
